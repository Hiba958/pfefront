<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ObjectApp - Profil</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <div class="header-left">
            <div class="app-name">
                <a href="Accueil.html">
                    <i class="fas fa-arrow-left"></i>
                    <img src="images/Capture_d_écran_2025-03-25_130909-removebg-preview.png" class="logo" alt="Logo">
                </a>
            </div>
            <button class="menu-btn" onclick="toggleMenu()">☰</button>

        </div>
        <nav id="mainNav">
            <ul>
                <li><button class="nav-button" data-target="configuration">Gestion des objets</button></li>
                <li><button class="nav-button" data-target="supervision">Supervision des données</button></li>
                <li><button class="nav-button" data-target="users">Gestion des utilisateurs</button></li>
                <li><button class="nav-button" data-target="reservations">Demandes de réservations</button></li>
                <li><button class="nav-button" data-target="contact">Contact</button></li>
            </ul>
        </nav>
        
        <button class="logout-button" onclick="logout()">Log out</button>

    </header>

    <main>
        <div id="welcome" class="content active">
            <h1>Les services offerts par notre application "HibaConnect" sont : </h1>
            <p>- Supervision en temps réel</p>
            <p>- Gestion des objets connectés</p>
            <p>- Sécurisation du réseau IOT</p>
            <p>- Détection et réponse aux menaces</p>
        </div>

        <div id="contact" class="content">
            <div class="profile-card">
                <div class="image">
                    <img src="images/télécharger-removebg-preview.png" class="profile-img" alt="Photo de profil">
                </div>
                <div class="text-data">
                    <span class="name">Hiba Amar</span>
                    <span class="job" style="color: black; display: block; margin-top: 5px;">Computer Engineer</span>
                </div>
                <div class="social-icons">
                    <a href="https://facebook.com" target="_blank" class="facebook"><i class="fab fa-facebook-f"></i></a>
                    <a href="https://instagram.com" target="_blank" class="instagram"><i class="fab fa-instagram"></i></a>
                    <a href="https://linkedin.com" target="_blank" class="linkedin"><i class="fab fa-linkedin-in"></i></a>
                  </div>
                  
                <div class="contact-info">
                    <div><i class="fas fa-phone-alt"></i> +216 56598431</div>
                    <div><i class="fas fa-envelope"></i> amarhiba010@gmail.com</div>
                    <div><i class="fas fa-map-marker-alt"></i> Sousse, Tunisie</div>
                </div>
                  
            </div>
        </div>

        <div id="configuration" class="content">
            <h3>Gestion des objets</h3>
            <button class="add-btn" onclick="afficherObjectForm()">+ Ajouter</button>
            <table id="sensorTable">
                <tr>
                    <th>ID</th>
                    <th>Nom d'objet</th>
                    <th>Référence</th>
                    <th>Disponibilité</th>
                    <th>Actions</th>
                </tr>
                <tr>
                    <td>1</td>
                    <td>Température</td>
                    <td>KY001TS</td>
                    <td>Disponible</td>
                    <td>
                        <button class="btn delete-btn" onclick="supprimerObjet('1')">
                            <i class="fas fa-trash"></i> Supprimer
                        </button>                        
                        <button class="btn connect-btn" onclick="connecterObjet('1')">
                            <i class="fas fa-link"></i> Connecter
                        </button>
                        
                    </td>
                </tr>
            </table>
            
            <div id="objectFormContainer" class="container-ajout">
                <button class="close-btn" onclick="fermerObjectForm()">X</button>
                <h4>Ajouter un objet</h4>
                <div class="form-group">
                    <label for="objectName">Nom de l'objet</label>
                    <input type="text" id="objectName" autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="objectReference">Référence</label>
                    <input type="text" id="objectReference" autocomplete="off">
                </div>
                <button class="submit-btn" onclick="ajouterObjet()">Ajouter</button>                
            </div>
        </div>
        <div id="supervision" class="content">
            <h3>Supervision des objets IOT</h3>
            <div class="supervision-container">
                <section class="capteurs">
                    <h2>Données des Capteurs</h2>
                    <div class="capteur" id="temperature">Température : -- °C</div>
                    <div class="capteur" id="humidite">Humidité : -- %</div>
                    <div class="capteur" id="luminosite">Luminosité : -- Lux</div>
                </section>
        
                <section class="controle">
                    <h2>Contrôle des LEDs</h2>
                   <button id="btn-red" onclick="toggleDevice('red')">Allumer LED Rouge</button>
                    <button id="btn-yellow" onclick="toggleDevice('yellow')">Allumer LED Jaune</button>
                    <button id="btn-green" onclick="toggleDevice('green')">Allumer LED Verte</button>
                    
                </section>
        
                <section class="alertes">
                    <h2>Alertes</h2>
                    <div id="alert-messages">Aucune alerte pour le moment.</div>
                    <div id="window-simulated">Fenêtre ouverte</div>
                </section>
            </div>
            
            <div class="graphique">
                    <h2>Graphiques</h2>
                    <canvas id="temperatureChart"  width="200" height="100"></canvas>
                    <canvas id="humidityChart"  width="200" height="100"></canvas>
                    <canvas id="luminosityChart" width="200" height="100"></canvas>
            </div>
        </div>
        <div id="users" class="content">
            <h3>Gestion des utilisateurs</h3>
            <!-- <button class="add-btn" onclick="afficherUserForm()">+ Ajouter</button> -->

            <table id="userTable">
                <tr>
                    <th>ID</th>
                    <th>Nom d'utilisateur</th>
                    <th>Actions</th>
                </tr>
                <tr>
                    <td>1</td>
                    <td>Admin</td>
                    <td>
                        <button class="btn delete-btn" onclick="supprimerUtilisateur('1')">
                            <i class="fas fa-trash"></i> Supprimer
                        </button>
                    </td>
                </tr>
            </table>
        
                
            
            <!-- <div id="userFormContainer" class="container-ajout">
                <button class="close-btn" onclick="fermerUserForm()">X</button>
                <h4>Ajouter un utilisateur</h4>
                <div class="form-group">
                    <label for="username">Nom d'utilisateur</label>
                    <input type="text" id="username" autocomplete="off">
                </div>
                <button class="submit-btn" onclick="ajouterUtilisateur()">Ajouter</button>                
            </div> -->
        </div>
        <div id="reservations" class="content">
            <h4>Liste des demandes</h4>
              <table id="reservationTable" border="1">
                <thead>
                  <tr>
                    <th>Utilisateur</th>
                    <th>Objet</th>
                    <th>Status</th>
                    <th>Date</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody id="reservationBody">
                </tbody>
              </table>
        </div>

    </main>

    <footer>
        Copyright © 2025. All rights reserved.
    </footer>
    <script>
    

        // Navigation entre les onglets
        document.addEventListener('DOMContentLoaded', function() {
            const navButtons = document.querySelectorAll('.nav-button');
            const contents = document.querySelectorAll('.content');
            
            navButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    contents.forEach(content => content.classList.remove('active'));
                    const target = this.getAttribute('data-target');
                    document.getElementById(target).classList.add('active');
                });
            });
            
            // Initialiser les graphiques
            initCharts();
            
            // Charger les données initiales
            chargerObjets();
            chargerUtilisateurs();

            // Add click event listener for the reservations button
            const reservationsButton = document.querySelector('[data-target="reservations"]');
            if (reservationsButton) {
                reservationsButton.addEventListener('click', fetchReservations);
            }
        });

        // Menu hamburger pour mobile
        function toggleMenu() {
            const nav = document.getElementById('mainNav');
            nav.classList.toggle('active');
        }

        // Fonctions pour la gestion des objets
        function afficherObjectForm() {
            document.getElementById("objectFormContainer").style.display = "block";
        }

        function fermerObjectForm() {
            document.getElementById("objectFormContainer").style.display = "none";
            document.getElementById('objectName').value = "";
            document.getElementById('objectReference').value = "";
        }

        function chargerObjets() {
            console.log("chargerObjets");
            fetch("https://lastback-q2av.onrender.com/api/devices")
                .then(response => response.json())
                .then(data => {
                    const table = document.getElementById("sensorTable");
                    // Garder l'en-tête du tableau
                    table.innerHTML = `
                        <tr>
                            <th>ID</th>
                            <th>Nom du capteur</th>
                            <th>Référence</th>
                            <th>Disponibilité</th>
                            <th>Actions</th>
                        </tr>
                    `;

                    data.forEach(objet => {
                        const row = table.insertRow();
                        row.innerHTML = `
                            <td>${objet._id}</td>
                            <td>${objet.name}</td>
                            <td>${objet.reference}</td>
                            <td>Disponible</td>
                            <td>
                                <button class="btn delete-btn" onclick="supprimerObjet('${objet._id}')">
                                    <i class="fas fa-trash"></i> Supprimer
                                </button>
                                <button class="btn connect-btn" onclick="connecterObjet('${objet._id}')">
                                    <i class="fas fa-link"></i> Connecter
                                </button>
                            </td>
                        `;
                    });
                })
                .catch(error => console.error("Erreur de chargement :", error));
        }

        function ajouterObjet() {
            const name = document.getElementById('objectName').value.trim();
            const reference = document.getElementById('objectReference').value.trim();

            if (!name || !reference) {
                alert("Veuillez remplir tous les champs !");
                return;
            }

            fetch("https://lastback-q2av.onrender.com/api/devices", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ name, reference, status: 'disponible' })
            })
            .then(response => response.json())
            .then(data => {
                console.log("Objet ajouté :", data);
                chargerObjets();
                fermerObjectForm();
                alert("Objet ajouté avec succès !");
            })
            .catch(error => {
                console.error("Erreur lors de l'ajout de l'objet :", error);
                alert("Erreur lors de l'ajout de l'objet.");
            });
        }

        function supprimerObjet(id) {
            if (!confirm("Voulez-vous vraiment supprimer cet objet ?")) return;
            
            fetch(`https://lastback-q2av.onrender.com/api/devices/${id}`, {
                method: "DELETE"
            })
            .then(response => response.json())
            .then(() => {
                chargerObjets();
                alert("Objet supprimé avec succès !");
            })
            .catch(error => {
                console.error("Erreur lors de la suppression :", error);
                alert("Erreur lors de la suppression.");
            });
        }

        function connecterObjet(id) {
            alert(`Connexion à l'objet ${id} est réussie`);
            // Ici vous ajouteriez la logique de connexion réelle
        }
        function changerDisponibilite(id, currentAvailability) {
            console.log("Changement de disponibilité pour l'objet avec ID:", id);
            const newAvailability = !currentAvailability; // toggle the availability
            fetch(`https://lastback-q2av.onrender.com/api/devices/${id}`, {
                method: "PATCH",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ availability: newAvailability })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    return response.json();
                } else {
            return response.text();
        }
    })
    .then(data => {
        if (typeof data === 'object') {
            console.log("Objet mis à jour:", data);
            alert("Disponibilité modifiée avec succès !");
            chargerObjets(); // Refresh the list
        } else {
            console.error("Non-JSON response received:", data);
            throw new Error("Server did not return JSON");
        }
    })
    .catch(error => {
        console.error("Erreur lors de la mise à jour de la disponibilité:", error);
        alert(error.error || "Erreur lors du changement de disponibilité.");
    }).finally(() => {
        chargerObjets();
    });
}

        function afficherUserForm() {
            document.getElementById("userFormContainer").style.display = "block";
        }

        function fermerUserForm() {
            document.getElementById("userFormContainer").style.display = "none";
            document.getElementById('username').value = "";
        }

        function chargerUtilisateurs() {
            fetch("https://lastback-q2av.onrender.com/api/users")
                .then(response => response.json())
                .then(users => {
                    const table = document.getElementById("userTable");
                    table.innerHTML = `
                        <tr>
                            <th>ID</th>
                            <th>Nom d'utilisateur</th>
                            <th>Actions</th>
                        </tr>
                    `;

                    users.forEach(user => {
                        if (user.role === "User") {
                            const row = table.insertRow();
                            row.innerHTML = `
                                <td>${user._id}</td>
                                <td>${user.username}</td>
                                <td>
                                    <button class="btn delete-btn" onclick="supprimerUtilisateur('${user._id}')">
                                        <i class="fas fa-trash"></i> Supprimer
                                    </button>
                                </td>
                            `;
                        }
                    });
                })
                .catch(error => console.error("Erreur lors du chargement des utilisateurs :", error));
        }

        // function ajouterUtilisateur() {
        //     const username = document.getElementById("username").value.trim();
        //     if (!username) {
        //         alert("Veuillez entrer un nom d'utilisateur !");
        //         return;
        //     }

        //     fetch("https://pfeback-zj61.onrender.com/api/users", {
        //         method: "POST",
        //         headers: { "Content-Type": "application/json" },
        //         body: JSON.stringify({ name:username })
        //     })
        //     .then(response => response.json())
        //     .then(data => {
        //         console.log("Utilisateur ajouté :", data);
        //         chargerUtilisateurs();
        //         fermerUserForm();
        //         alert("Utilisateur ajouté avec succès !");
        //     })
        //     .catch(error => {
        //         console.error("Erreur lors de l'ajout de l'utilisateur :", error);
        //         alert("Erreur lors de l'ajout de l'utilisateur.");
        //     });
        // }

        function supprimerUtilisateur(id) {
            if (!confirm("Voulez-vous vraiment supprimer cet utilisateur ?")) return;
            
            fetch(`https://lastback-q2av.onrender.com/api/users/${id}`, {
                method: "DELETE"
            })
            .then(response => response.json())
            .then(() => {
                chargerUtilisateurs();
                alert("Utilisateur supprimé avec succès !");
            })
            .catch(error => {
                console.error("Erreur lors de la suppression de l'utilisateur :", error);
                alert("Erreur lors de la suppression.");
            });
        }
               const apiBase = "https://lastback-q2av.onrender.com/api/sensors";
        let ledStates = { red: false, yellow: false, green: false };

        function initCharts() {
            const ctxTemperature = document.getElementById('temperatureChart')?.getContext('2d');
            const ctxHumidity = document.getElementById('humidityChart')?.getContext('2d');
            const ctxLuminosity = document.getElementById('luminosityChart')?.getContext('2d');

            if (!ctxTemperature || !ctxHumidity || !ctxLuminosity) {
                console.error("Erreur : Un ou plusieurs éléments <canvas> sont manquants.");
                return;
            }

            window.temperatureChart = new Chart(ctxTemperature, {
                type: 'doughnut',
                data: {
                    labels: ['Température', 'Reste'],
                    datasets: [{
                        label: 'Température (°C)',
                        data: [0, 100],
                        backgroundColor: ['#FF5733', '#F0F0F0'],
                        borderColor: ['#FF5733', '#F0F0F0'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: 'white', font: { size: 30, weight: 'bold' } }
                        }
                    }
                }
            });

            window.humidityChart = new Chart(ctxHumidity, {
                type: 'doughnut',
                data: {
                    labels: ['Humidité', 'Reste'],
                    datasets: [{
                        label: 'Humidité (%)',
                        data: [0, 100],
                        backgroundColor: ['#4CAF50', '#F0F0F0'],
                        borderColor: ['#4CAF50', '#F0F0F0'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: 'white', font: { size: 30, weight: 'bold' } }
                        }
                    }
                }
            });

            window.luminosityChart = new Chart(ctxLuminosity, {
                type: 'doughnut',
                data: {
                    labels: ['Luminosité', 'Reste'],
                    datasets: [{
                        label: 'Luminosité (Lux)',
                        data: [0, 1000],
                        backgroundColor: ['#FFD700', '#F0F0F0'],
                        borderColor: ['#FFD700', '#F0F0F0'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: 'white', font: { size: 30, weight: 'bold' } }
                        }
                    }
                }
            });

            // Test statique pour vérifier l'affichage
            document.getElementById("temperature").textContent = "Test 25 °C";
            fetchSensorData();
            setInterval(fetchSensorData, 5000);
        }

        async function fetchSensorData() {
            try {
                const res = await fetch(`${apiBase}/latest`, { timeout: 10000 });
                console.log('Statut HTTP :', res.status, 'OK :', res.ok);

                if (!res.ok) {
                    throw new Error(`Erreur HTTP : ${res.status}`);
                }

                const data = await res.json();
                console.log('Données reçues :', data);

                if (!data || typeof data.temperature === 'undefined' || typeof data.humidite === 'undefined' || typeof data.luminosite === 'undefined') {
                    throw new Error('Données invalides ou absentes');
                }

                const temperature = data.temperature;
                const humidity = data.humidite;
                const luminosity = data.luminosite;

                const tempElement = document.getElementById("temperature");
                const humElement = document.getElementById("humidite");
                const lumElement = document.getElementById("luminosite");
                const windowElement = document.getElementById("window-simulated");

                if (!tempElement || !humElement || !lumElement || !windowElement) {
                    console.error("Erreur : Un ou plusieurs éléments HTML sont manquants.");
                    return;
                }

                tempElement.textContent = `Température : ${temperature.toFixed(1)} °C`;
                humElement.textContent = `Humidité : ${humidity.toFixed(1)} %`;
                lumElement.textContent = `Luminosité : ${luminosity} Lux`;

                // Gérer la fenêtre simulée
                windowElement.classList.toggle('open', luminosity > 1500);

                updateCharts(temperature, humidity, luminosity);
                checkAlertes(temperature, humidity, luminosity);
            } catch (error) {
                console.error("Erreur lors de la récupération des données capteurs :", error);
                const alertDiv = document.getElementById("alert-messages");
                if (alertDiv) {
                    alertDiv.innerHTML = "⚠️ Erreur de connexion au serveur.";
                    alertDiv.style.color = "red";
                }
            }
        }

        function updateCharts(temperature, humidity, luminosity) {
            if (window.temperatureChart && window.humidityChart && window.luminosityChart) {
                window.temperatureChart.data.datasets[0].data = [temperature, 100 - temperature];
                window.humidityChart.data.datasets[0].data = [humidity, 100 - humidity];
                window.luminosityChart.data.datasets[0].data = [luminosity, 1000 - luminosity];

                window.temperatureChart.update();
                window.humidityChart.update();
                window.luminosityChart.update();
            } else {
                console.error("Erreur : Les graphiques ne sont pas initialisés.");
            }
        }

        function checkAlertes(temperature, humidity, luminosity) {
            let alertMessage = "";
            if (temperature > 30) alertMessage += "⚠️ Température trop élevée !<br>";
            if (humidity < 30) alertMessage += "⚠️ Humidité trop basse !<br>";
            if (luminosity > 1500) alertMessage += "⚠️ Luminosité suffisante, fenêtre ouverte !<br>";

            const alertDiv = document.getElementById("alert-messages");
            if (alertDiv) {
                alertDiv.innerHTML = alertMessage || "Aucune alerte pour le moment.";
                alertDiv.style.color = alertMessage ? "red" : "green";
            } else {
                console.error("Erreur : Élément alert-messages manquant.");
            }
        }

        async function toggleDevice(led) {
            ledStates[led] = !ledStates[led];
            try {
                const response = await fetch(`${apiBase}/control`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        red: ledStates.red,
                        yellow: ledStates.yellow,
                        green: ledStates.green
                    })
                });

                if (!response.ok) {
                    throw new Error(`Erreur HTTP : ${response.status}`);
                }

                const btn = document.getElementById(`btn-${led}`);
                if (btn) {
                    btn.textContent = ledStates[led] ? `Éteindre LED ${led.charAt(0).toUpperCase() + led.slice(1)}` : `Allumer LED ${led.charAt(0).toUpperCase() + led.slice(1)}`;
                }
            } catch (error) {
                console.error(`Erreur lors du contrôle de la LED ${led} :`, error);
                ledStates[led] = !ledStates[led]; // Revertir l'état en cas d'erreur
            }
        }

        window.addEventListener('DOMContentLoaded', initCharts);
        // Déconnexion
        function logout() {
            localStorage.clear();
            sessionStorage.clear();
            window.location.href = "login.html";
        }
        
        // Function to fetch and display reservations
        function fetchReservations() {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('Veuillez vous connecter pour voir les demandes de réservation');
                window.location.href = 'login.html';
                return;
            }

            fetch('https://lastback-q2av.onrender.com/api/reservations', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(reservations => {
                const tbody = document.getElementById('reservationBody');
                tbody.innerHTML = '';

                if (!reservations || reservations.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = '<td colspan="5" style="text-align: center;">Aucune demande de réservation</td>';
                    tbody.appendChild(row);
                    return;
                }

                reservations.forEach(reservation => {
                    const row = document.createElement('tr');
                    const date = new Date(reservation.createdAt);
                    const formattedDate = date.toLocaleDateString('fr-FR', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    // Safely access nested properties with fallbacks
                    const username = reservation.user?.username || 'Utilisateur inconnu';
                    const deviceName = reservation.device?.name || 'Objet inconnu';
                    const status = reservation.status || 'en_attente';

                    row.innerHTML = `
                        <td>${username}</td>
                        <td>${deviceName}</td>
                        <td>${status}</td>
                        <td>${formattedDate}</td>
                        <td>
                            <button class="btn accept-btn" onclick="updateReservationStatus('${reservation._id}', 'validée')">
                                <i class="fas fa-check"></i> Accepter
                            </button>
                            <button class="btn reject-btn" onclick="updateReservationStatus('${reservation._id}', 'refusée')">
                                <i class="fas fa-times"></i> Refuser
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            })
            .catch(error => {
                console.error('Error fetching reservations:', error);
                alert('Erreur lors de la récupération des demandes de réservation');
            });
        }

        // Function to update reservation status
        function updateReservationStatus(reservationId, status) {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('Veuillez vous connecter pour gérer les réservations');
                window.location.href = 'login.html';
                return;
            }

            fetch(`https://lastback-q2av.onrender.com/api/reservations/${reservationId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ status })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                alert(data.message || 'Statut de la réservation mis à jour');
                fetchReservations(); // Refresh the list
            })
            .catch(error => {
                console.error('Error updating reservation status:', error);
                alert('Erreur lors de la mise à jour du statut de la réservation');
            });
        }
    </script>
</body>
</html>
